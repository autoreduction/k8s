---
- name: Deployment of queue-processor
  run_once: true
  block:
    - name: Create a k8s namespace
      kubernetes.core.k8s:
        name: queue-processor
        api_version: v1
        kind: Namespace
        state: present

    - name: Ensure deployment of queue-processor
      kubernetes.core.k8s:
        definition: "{{ lookup('template', 'templates/%s' % item) | from_yaml_all | list }}"
        state: present
      loop:
        - qp-configmap.yaml.j2
        - qp-secret.yaml.j2
        - service.yaml.j2
        - serviceaccount.yaml.j2
        - deployment.yaml.j2

    - name: Wait for queue-processor to be ready
      kubernetes.core.k8s:
        state: present
        kind: Deployment
        api_version: apps/v1
        wait: true
        wait_sleep: 10
        wait_condition:
          type: Ready
          status: "True"
        name: "queue-processor"
        namespace: "queue-processor"
        wait_timeout: 120
